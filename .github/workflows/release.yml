name: Release

on:
  push:
    branches: [main]
    tags: ['v*']

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"
            echo "tag=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
            echo "prerelease=false" >> "$GITHUB_OUTPUT"
          else
            # For main branch builds, use a timestamp-based version
            SHORT_SHA=$(git rev-parse --short HEAD)
            DATE=$(date -u +%Y%m%d-%H%M%S)
            echo "version=0.0.0-${DATE}-${SHORT_SHA}" >> "$GITHUB_OUTPUT"
            echo "tag=build-${DATE}-${SHORT_SHA}" >> "$GITHUB_OUTPUT"
            echo "prerelease=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Build release binary
        run: swift build -c release --product Hypersync

      - name: Import signing certificate
        env:
          APPLE_CERTIFICATE_P12_BASE64: ${{ secrets.APPLE_CERTIFICATE_P12_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        if: env.APPLE_CERTIFICATE_P12_BASE64 != ''
        run: |
          CERT_PATH="$RUNNER_TEMP/certificate.p12"
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain"
          echo "$APPLE_CERTIFICATE_P12_BASE64" | base64 --decode > "$CERT_PATH"
          security create-keychain -p "" "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"
          security unlock-keychain -p "" "$KEYCHAIN_PATH"
          security import "$CERT_PATH" -k "$KEYCHAIN_PATH" -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "" "$KEYCHAIN_PATH"
          rm "$CERT_PATH"

      - name: Decode notarization key
        env:
          NOTARIZE_KEY_P8_BASE64: ${{ secrets.NOTARIZE_KEY_P8_BASE64 }}
        if: env.NOTARIZE_KEY_P8_BASE64 != ''
        run: |
          KEY_PATH="$RUNNER_TEMP/notarize_key.p8"
          echo "$NOTARIZE_KEY_P8_BASE64" | base64 --decode > "$KEY_PATH"

      - name: Package and sign app bundle (DMG is notarized instead)
        env:
          SKIP_BUILD: "1"
          SKIP_NOTARIZE: "1"
          CODESIGN_IDENTITY: ${{ secrets.CODESIGN_IDENTITY || '-' }}
          VERSION: ${{ steps.version.outputs.version }}
          BUILD_NUMBER: ${{ github.run_number }}
        run: ./scripts/package_app.sh

      - name: Create ZIP (always)
        run: |
          cd dist
          ditto -c -k --sequesterRsrc --keepParent "Hypersync.app" \
            "Hypersync-MacOS.zip"

      - name: Create DMG with drag-to-Applications layout (retry)
        id: create_dmg
        continue-on-error: true
        run: |
          for attempt in 1 2 3; do
            if ./scripts/create_dmg.sh; then
              echo "created=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            echo "DMG creation attempt $attempt failed."
            if [[ "$attempt" -lt 3 ]]; then
              sleep 3
            fi
          done

          echo "created=false" >> "$GITHUB_OUTPUT"
          echo "::warning::DMG creation failed after retries; continuing with ZIP artifact."
          exit 1

      - name: Sign DMG
        env:
          CODESIGN_IDENTITY: ${{ secrets.CODESIGN_IDENTITY }}
        if: steps.create_dmg.outputs.created == 'true' && env.CODESIGN_IDENTITY != '' && env.CODESIGN_IDENTITY != '-'
        run: codesign --force --sign "$CODESIGN_IDENTITY" dist/Hypersync-MacOS.dmg

      - name: Notarize DMG
        env:
          NOTARIZE_KEY_P8_BASE64: ${{ secrets.NOTARIZE_KEY_P8_BASE64 }}
          NOTARIZE_KEY_ID: ${{ secrets.NOTARIZE_KEY_ID }}
          NOTARIZE_ISSUER_ID: ${{ secrets.NOTARIZE_ISSUER_ID }}
        if: steps.create_dmg.outputs.created == 'true' && env.NOTARIZE_KEY_P8_BASE64 != ''
        run: |
          KEY_PATH="$RUNNER_TEMP/notarize_key.p8"
          xcrun notarytool submit dist/Hypersync-MacOS.dmg \
            --key "$KEY_PATH" \
            --key-id "$NOTARIZE_KEY_ID" \
            --issuer "$NOTARIZE_ISSUER_ID" \
            --wait

          xcrun stapler staple dist/Hypersync-MacOS.dmg || {
            echo "Warning: stapling failed. The DMG is still notarized — Gatekeeper checks online."
          }

      - name: Clean up signing secrets
        if: always()
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain"
          [ -f "$KEYCHAIN_PATH" ] && security delete-keychain "$KEYCHAIN_PATH" || true
          rm -f "$RUNNER_TEMP/notarize_key.p8" "$RUNNER_TEMP/certificate.p12"

      - name: Ensure GitHub Release exists
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          TITLE="${{ steps.version.outputs.tag == 'latest' && 'Latest Build' || steps.version.outputs.tag }}"
          PRERELEASE_FLAG=""
          if [[ "${{ steps.version.outputs.prerelease }}" == "true" ]]; then
            PRERELEASE_FLAG="--prerelease"
          fi

          NOTES_FILE="$RUNNER_TEMP/release-notes.md"
          cat > "$NOTES_FILE" <<'EOF'
          ## Install

          **Option A — DMG (recommended)**
          1. Download **Hypersync-MacOS.dmg**
          2. Open the DMG and drag **Hypersync** to Applications
          3. Launch from Applications or Spotlight

          **Option B — ZIP**
          1. Download **Hypersync-MacOS.zip**
          2. Unzip and move **Hypersync.app** to `/Applications`
          3. Launch from Applications or Spotlight

          Then click the menu bar icon → **Settings** to configure.

          > Requires macOS 14 (Sonoma) or later. Universal binary (Apple Silicon + Intel).
          EOF

          if gh release view "$TAG" >/dev/null 2>&1; then
            gh release edit "$TAG" --title "$TITLE" $PRERELEASE_FLAG --notes-file "$NOTES_FILE"
          else
            gh release create "$TAG" --title "$TITLE" $PRERELEASE_FLAG --notes-file "$NOTES_FILE"
          fi

      - name: Upload release assets
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          FILES=()

          [[ -f dist/Hypersync-MacOS.zip ]] && FILES+=("dist/Hypersync-MacOS.zip")
          [[ -f dist/Hypersync-MacOS.dmg ]] && FILES+=("dist/Hypersync-MacOS.dmg")

          if [[ "${#FILES[@]}" -eq 0 ]]; then
            echo "No release artifacts found in dist/." >&2
            exit 1
          fi

          gh release upload "$TAG" "${FILES[@]}" --clobber
